name: Trigger auto deployment for maggietestrevisionapp

on:
  push:
    branches: [ main ]
    paths:
      - '**'                       # 任何檔案變更（包含 workflow 檔）都會觸發
  workflow_dispatch:               # 也支援手動觸發

jobs:
  deploy-existing-image:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.MAGGIETESTREVISIONAPP_AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.MAGGIETESTREVISIONAPP_AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.MAGGIETESTREVISIONAPP_AZURE_SUBSCRIPTION_ID }}

      # 可選：部署前先確認 ACR 的 tag 存在，避免 MANIFEST_UNKNOWN
      - name: Verify image tag exists in ACR
        run: |
          az acr repository show-tags -n maggieacr --repository dotnet/samples -o tsv \
          | grep -x "aspnetapp" || { echo "::error::ACR 找不到 tag aspnetapp"; exit 1; }

      - name: Deploy existing image to Container App
        uses: azure/container-apps-deploy-action@v2
        with:
          resourceGroup: maggiehou-containerapp
          containerAppName: maggietestrevisionapp
          imageToDeploy: maggieacr.azurecr.io/dotnet/samples:aspnetapp
          registryUrl: maggieacr.azurecr.io
          registryUsername: ${{ secrets.MAGGIETESTREVISIONAPP_REGISTRY_USERNAME }}
          registryPassword: ${{ secrets.MAGGIETESTREVISIONAPP_REGISTRY_PASSWORD }}
